from google import genai
from google.genai import types
import os
from dotenv import load_dotenv
from RealtimeSTT import AudioToTextRecorder

load_dotenv()

def main():
    api_key = os.getenv("GEMINI_API_KEY")

    if not api_key:
        raise ValueError("GEMINI_API_KEY environment variable not set")

    client = genai.Client(api_key=api_key)
    print("API KEY is fine! âœ…\nSay 'exit' to quit.\n")

    # Initialise le micro une seule fois
    recorder = AudioToTextRecorder(model="tiny.en", language="en", spinner=False)

    while True:
        print("You:", end="", flush=True)
        user_input = recorder.text()
        print(user_input)

        if user_input.lower() == "exit":
            print("Exitingâ€¦ ðŸ‘‹")
            break

        # CrÃ©e un nouveau chat pour chaque message pour Ã©viter le canal fermÃ©
        chat = client.chats.create(
            model="gemini-2.5-flash",
            config=types.GenerateContentConfig(
                system_instruction="MY NAME IS YASMIN",
                thinking_config=types.ThinkingConfig(thinking_budget=0)
            ),
        )

        try:
            response = chat.send_message(user_input)
            # Combine tous les chunks en une seule string pour Ã©viter le "shaking"
            response_text = "".join([chunk.text for chunk in response])
            print("AI:", response_text)
        except Exception as e:
            print("Erreur avec le chat Gemini:", e)
            print("RÃ©essayez...")

if __name__ == "__main__":
    main()
